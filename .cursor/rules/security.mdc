# 安全规范

## 敏感信息管理

### 绝不能提交到 Git 的文件
- `backend/data/config.json` - 含 DashScope API Key、OSS 密钥
- `backend/data/users.json` - 用户密码
- `backend/data/sessions.json` - 会话 token
- `backend/data/users/` - 用户私有数据目录

### .gitignore 配置
确保以下内容在 `.gitignore` 中：
```
backend/data/users/
backend/data/users.json
backend/data/sessions.json
backend/data/config.json
```

### 配置文件模板
- 提供 `*.example.json` 作为模板
- 用户复制后填入真实值
- 示例文件中使用占位符，如 `"your-api-key-here"`

## API Key 安全

### 存储位置
- 仅存储在 `backend/data/config.json`
- 通过用户 config 存储用户级别的 Key
- **从不** 在代码中硬编码

### 泄露处理
如果 API Key 泄露：
1. **立即** 在阿里云控制台禁用该 Key
2. 创建新的 API Key
3. 更新本地配置
4. 如已提交 Git，使用 `git-filter-repo` 清理历史

### 清理 Git 历史
```bash
# 安装工具
pip install git-filter-repo

# 从历史中删除敏感文件
git filter-repo --path backend/data/users.json --invert-paths --force

# 强制推送（谨慎操作）
git push origin --force --all
```

## 用户数据保护

### 密码存储
- 当前使用明文存储（仅适合本地开发）
- 生产环境应使用 bcrypt 哈希

### 会话管理
- 使用随机生成的 token
- token 存储在 `sessions.json`
- 定期清理过期会话

### 用户隔离
- 每个用户有独立的数据目录
- 使用 `contextvars` 实现请求级用户上下文
- 路径：`backend/data/users/{user_id}/`

## 部署安全

### 端口暴露
- 前端 3000 端口：需要对外
- 后端 8000 端口：通过 Vite 代理，无需对外暴露

### 云服务器安全组
- 仅放行必要端口
- 限制 SSH 来源 IP
- 定期更新系统

## 开发环境安全

### 环境变量
可使用环境变量覆盖配置：
```bash
export DASHSCOPE_API_KEY="your-key"
```

### 本地测试
- 使用测试账号的 API Key
- 定期轮换测试 Key
- 不要在测试中使用生产数据

## 安全检查清单

- [ ] `.gitignore` 包含所有敏感文件
- [ ] 配置文件不含真实密钥
- [ ] Git 历史无敏感数据
- [ ] API Key 定期轮换
- [ ] 用户密码安全存储
- [ ] 会话 token 安全生成
