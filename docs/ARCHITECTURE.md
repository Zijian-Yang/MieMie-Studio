# 系统架构

## 技术栈

### 后端
| 技术 | 用途 | 版本 |
|------|------|------|
| FastAPI | Web 框架 | 0.100+ |
| Pydantic | 数据验证 | 2.0+ |
| DashScope SDK | 阿里云 AI 服务 | latest |
| httpx | 异步 HTTP 客户端 | latest |
| Pillow | 图像处理 | latest |
| oss2 | 阿里云 OSS SDK | latest |

### 前端
| 技术 | 用途 | 版本 |
|------|------|------|
| React | UI 框架 | 18.x |
| TypeScript | 类型安全 | 5.x |
| Vite | 构建工具 | 5.x |
| Ant Design | UI 组件库 | 5.x |
| Zustand | 状态管理 | 4.x |
| React Router | 路由 | 6.x |
| Axios | HTTP 客户端 | latest |

## 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        前端 (React + Vite)                        │
├─────────────────────────────────────────────────────────────────┤
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────────────┐ │
│  │  Pages   │  │Components│  │  Stores  │  │   Services/API   │ │
│  │ (页面)   │  │ (组件)   │  │ (状态)   │  │   (API 调用)     │ │
│  └──────────┘  └──────────┘  └──────────┘  └──────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                              ▼ HTTP/REST
┌─────────────────────────────────────────────────────────────────┐
│                      后端 (FastAPI)                              │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                    Middleware (中间件)                       ││
│  │  ┌─────────────┐  ┌─────────────┐  ┌───────────────────┐   ││
│  │  │    CORS     │  │    Auth     │  │  User Context     │   ││
│  │  │  (跨域)     │  │   (认证)    │  │  (用户上下文)     │   ││
│  │  └─────────────┘  └─────────────┘  └───────────────────┘   ││
│  └─────────────────────────────────────────────────────────────┘│
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                      Routers (路由)                          ││
│  │  auth | settings | projects | scripts | characters | ...    ││
│  └─────────────────────────────────────────────────────────────┘│
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                     Services (服务层)                        ││
│  │  ┌──────────────────┐  ┌──────────────┐  ┌───────────────┐ ││
│  │  │    DashScope     │  │    Storage   │  │    OSS        │ ││
│  │  │  (AI 服务封装)   │  │  (数据存储)  │  │  (文件存储)   │ ││
│  │  └──────────────────┘  └──────────────┘  └───────────────┘ ││
│  └─────────────────────────────────────────────────────────────┘│
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                      Config (配置)                           ││
│  │  模型配置 | 用户配置 | API 区域配置                          ││
│  └─────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                       外部服务                                   │
├─────────────────────────────────────────────────────────────────┤
│  ┌──────────────────┐  ┌────────────────┐  ┌─────────────────┐ │
│  │   DashScope API  │  │   阿里云 OSS    │  │   本地文件系统   │ │
│  │  (文生图/视频)   │  │  (图片/视频)   │  │   (JSON 数据)   │ │
│  └──────────────────┘  └────────────────┘  └─────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## 请求处理流程

```
用户请求
    │
    ▼
┌──────────────────┐
│   CORS 中间件     │  ← 处理跨域
└──────────────────┘
    │
    ▼
┌──────────────────┐
│   Auth 中间件     │  ← 验证 Token，设置用户上下文
└──────────────────┘
    │
    ▼
┌──────────────────┐
│   Router         │  ← 路由分发
└──────────────────┘
    │
    ▼
┌──────────────────┐
│   Depends        │  ← 依赖注入（获取用户存储服务）
└──────────────────┘
    │
    ▼
┌──────────────────┐
│   Handler        │  ← 业务处理
└──────────────────┘
    │
    ▼
┌──────────────────┐
│   Service        │  ← 调用服务层
└──────────────────┘
    │
    ▼
┌──────────────────┐
│   清除上下文      │  ← 请求结束，清除 ContextVar
└──────────────────┘
```

## 多用户数据隔离

### 数据目录结构

```
backend/data/
├── users.json              # 用户列表（全局）
├── sessions.json           # 会话列表（全局）
├── config.json             # 默认配置（向后兼容）
└── users/
    ├── {user_id_1}/        # 用户 1 专属目录
    │   ├── config.json     # 用户配置（API Key、OSS 等）
    │   ├── projects/       # 项目数据
    │   ├── characters/     # 角色数据
    │   ├── scenes/         # 场景数据
    │   ├── props/          # 道具数据
    │   ├── frames/         # 分镜首帧数据
    │   ├── videos/         # 视频数据
    │   ├── gallery/        # 图库数据
    │   ├── studio/         # 图片工作室数据
    │   ├── video_studio/   # 视频工作室数据
    │   ├── audio/          # 音频库数据
    │   ├── video_library/  # 视频库数据
    │   └── text_library/   # 文本库数据
    └── {user_id_2}/        # 用户 2 专属目录
        └── ...
```

### 上下文传递机制

使用 Python `contextvars` 实现请求级别的用户上下文：

```python
# 1. AuthMiddleware 设置上下文
set_current_user(user_id)
set_user_config_dir(user_data_path)
set_log_user_context(username)

# 2. StorageServiceProxy 自动路由
storage_service._get_service()  # 返回用户专属的 StorageService

# 3. 配置也按用户隔离
get_config()  # 返回用户专属配置

# 4. 请求结束后清除
clear_user_context()
```

## 并发安全

### 文件锁

JSON 文件读写使用 `fcntl.flock`：
- 读取：共享锁 `LOCK_SH`
- 写入：排他锁 `LOCK_EX`

### 内存锁

StorageService 使用 `threading.RLock` 保护内存中的操作。

## 日志系统

### 日志文件
- 位置: `backend/logs/api_YYYYMMDD.log`
- 轮转: 10MB 最大，保留 10 个备份
- 格式: `时间 | 级别 | [用户] 模块:行号 | 消息`

### 日志包含
- 用户上下文（用户名）
- API 请求/响应详情
- DashScope 调用参数和结果
- 错误堆栈

---

*最后更新: 2025-12-30*

